@using Microsoft.EntityFrameworkCore
@using ShopScout.SharedLib.Services
@using System.Linq.Expressions
@typeparam T where T : class
@inject IUserAccessor UserAccessor

<svg xmlns="http://www.w3.org/2000/svg" @onclick="ToggleFavourite"
     viewBox="0 0 24 24" width="36" height="36" style="cursor: pointer; overflow: visible;">
    <style>
        .star {
            fill: none;
            stroke: #fbbf24;
            stroke-width: 2;
            stroke-linejoin: round;
            transition: fill 0.2s ease;
            transform-origin: center;
        }

            .star.filled {
                fill: #fbbf24;
                animation: starPop 0.5s cubic-bezier(0.26, 0.53, 0.74, 1.48);
            }

        @@keyframes starPop {
            0% {
                transform: scale(1) rotate(0deg);
            }

            50% {
                transform: scale(1.3) rotate(-10deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }
    </style>
    <path class="star @(Favourited ? "filled" : "")"
          d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
</svg>

@code {
    [Parameter] public bool Favourited { get; set; }

    [Parameter] public EventCallback<bool> FavouritedChanged { get; set; }

    [Parameter] public Expression<Func<ApplicationUser, ICollection<T>>>? NavigationProperty { get; set; }

    [Parameter] public T EntryToAlter { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (await UserAccessor.IsAuthenticatedAsync())
        {
            var user = await UserAccessor.GetCurrentUserAsync(NavigationProperty);

            if (user != null && NavigationProperty != null)
            {
                var getter = NavigationProperty.Compile();
                var collection = getter(user);

                if (collection != null)
                {
                    var entryIdProp = typeof(T).GetProperty("Id");
                    var entryId = (int)(entryIdProp?.GetValue(EntryToAlter) ?? 0);

                    var favourited = collection.Any(x =>
                    {
                        var xId = (int)(entryIdProp?.GetValue(x) ?? 0);
                        return xId == entryId;
                    });

                    await FavouritedChanged.InvokeAsync(favourited);
                }
            }
        }
    }

    private async Task ToggleFavourite(MouseEventArgs args)
    {
        var user = await UserAccessor.RequireAuthenticatedUserAsync();
        if (user is null) return;
        if (Favourited)
        {
            await FavouritedChanged.InvokeAsync(false);
            await UserAccessor.RemoveFromCollectionAsync(user, NavigationProperty, EntryToAlter);
        }
        else
        {
            await FavouritedChanged.InvokeAsync(true);
            await UserAccessor.AddToCollectionAsync(user, NavigationProperty, EntryToAlter);
        }
    }
}