@page "/reader"
@rendermode InteractiveAuto
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@layout EmptyLayout

<BarcodeReader ScanResult="ScanResult"
               Close="(() => ShowScanBarCode = !ShowScanBarCode)"
               OnError="OnError"
               UseBuiltinDiv="false"
               @ref="barcodeReader" />

<video id="video" playsinline autoplay></video>

<div class="scanner-container">
    <div class="overlay-gradient"></div>

    <div class="top-controls">
        <button class="_btn btn-back" @onclick="Back">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m12 19-7-7 7-7" />
                <path d="M19 12H5" />
            </svg>
            Vissza
        </button>

        <div class="dropdown" id="cameraDropdown">
            <div class="dropdown-backdrop" onclick="closeDropdown()"></div>
            <button class="dropdown-trigger" onclick="toggleDropdown()">
                <span class="dropdown-text">Select Camera</span>
                <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 12,15 18,9"></polyline>
                </svg>
            </button>
            <div class="dropdown-content" @ref="barcodeReader.Element">
            </div>
        </div>

        <button class="_btn btn-flashlight" onclick="handleFlashlightToggle()">
            <svg class="icon flashlight-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6c0 2-2 2-2 4v10a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2V10c0-2-2-2-2-4V2h12z" />
                <line x1="6" x2="18" y1="6" y2="6" />
                <line x1="12" x2="12" y1="12" y2="12" />
                <line x1="2" x2="22" y1="2" y2="22" />
            </svg>
        </button>
    </div>

    <div class="scanning-area">
        <div class="frame-border">
            <div class="corner top-left"></div>
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="corner bottom-right"></div>
            <div class="scanning-line"></div>
        </div>
        <p class="instructions">Igazítsd a vonalkódot a keretbe</p>
    </div>
</div>

@code{
    [Parameter] public EventCallback<string> OnScan { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    private string message;
    bool ShowScanBarCode { get; set; } = false;
    public string? BarCode { get; set; }
    private BarcodeReader? barcodeReader;


    private Task OnError(string message)
    {
        this.message = message;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task ScanResult(string barcode)
    {
        await barcodeReader.DisposeAsync();
        if (OnScan.HasDelegate)
        {
            await OnScan.InvokeAsync(barcode);
        }
        else
        {
            NavigationManager.NavigateTo($"/product/{barcode}");
        }
    }

    private async Task Back()
    {
        await barcodeReader.DisposeAsync();
        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
        else
        {
            await JS.InvokeVoidAsync("history.back");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("eval", "import('/js/barcodeReaderFe.js')");
        }
    }
}