@page "/product/{barcode?}"
@using ShopScout.SharedLib.Services
@using ShopScout.SharedLib.Models
@using System.Text
@using System.Globalization
@inject IProductService ProductService
@inject IStoreService StoreService
@inject IUserAccessor UserAccessor
@inject LocationService LocationService
@inject HttpClient _client
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@inject StorageService LocalStorageService
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<div>@(translation)</div>
<div class="outer-container">
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <p class="loading-text">Termékadatok betöltése...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-card">
            <div class="error-icon">⚠️</div>
            <h3>Nem található ilyen termék</h3>
            <p>@errorMessage</p>
            <button class="btn-primary" @onclick="ShowSearchForm">Próbálj meg egy másik vonalkódot</button>
        </div>
    }
    else if (product == null)
    {
        <div class="search-container">
            <div class="search-card">
                <div class="search-header">
                    <h1>Fedezz fel termékeket</h1>
                    <p>Írj be egy vonalkódot, hogy részletes tápanyag- és összetevő elemzést kapj</p>
                </div>

                <div class="search-form">
                    <div class="input-group">
                        <div class="input-icon">🔍</div>
                        <input type="text"
                               class="search-input"
                               @bind="searchBarcode"
                               placeholder="Írd be a vonalkódot (Pl.: 5000112611861)"
                               @onkeypress="OnKeyPress" />
                    </div>
                    <button class="search-btn"
                            @onclick="SearchForBarcode">
                        <span>Termék keresése</span>
                        <div class="btn-shine"></div>
                    </button>
                    <button class="search-btn"
                            @onclick="GoToReader">
                        <span>Vonalkód beolvasása</span>
                        <div class="btn-shine"></div>
                    </button>
                </div>

                <div class="search-examples">
                    <p>Próbáld ki ezeket:</p>
                    <div class="example-codes">
                        <button class="example-btn" @onclick='() => SearchExample("5000112611861")'>Coca-Cola</button>
                        <button class="example-btn" @onclick='() => SearchExample("3017620422003")'>Nutella</button>
                        <button class="example-btn" @onclick='() => SearchExample("8001505005707")'>Barilla Pasta</button>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="product-container">
            <!-- Header with Search -->
            <div class="product-header">
                <button class="back-btn" @onclick="ShowSearchForm">
                    <span>←</span> Vissza a kereséshez
                </button>
                <div class="product-meta">
                    <span class="barcode-chip">𝄃𝄃𝄂 @product.Code</span>
                    @if (product.Countries.Count > 0)
                    {
                        <span class="country-chip">🌍 @product.Countries.First().Name</span>
                    }
                    <span class="edit-chip" title="Szerkesztés">
                        <img src="/svg/edit-icon.svg" class="nav-svg-icon" alt="Termékszerkesztő ikonja" @onclick='() => NavigationManager.NavigateTo($"/product/{Barcode}/edit")'/>
                    </span>
                </div>
            </div>

            <!-- Hero Section -->
            <div class="hero-section">
                <div class="product-image-container">
                    @{
                        var primaryImageUrl = product.ProductImages.FirstOrDefault(pi => pi.ImageType == ProductImageType.Primary)?.URL;
                        if (!string.IsNullOrEmpty(primaryImageUrl))
                        {
                            <img src="@primaryImageUrl" class="hero-image" alt="A termék képe" />
                            <div class="image-overlay"></div>
                        }
                        else
                        {
                            <div class="placeholder-image">
                                <div class="placeholder-icon">📦</div>
                                <span>Nincs elérhető kép</span>
                            </div>
                        }
                    }

                </div>

                <div class="hero-content">
                    <h1 class="product-title">
                        @product.ProductName
                        <FavouriteButton T="Product" EntryToAlter="product" @bind-Favourited="favourited" NavigationProperty="u => u.FavoriteProducts" />
                    </h1>
                    @if (!string.IsNullOrEmpty(product.Description))
                    {
                        <p class="product-subtitle"><TranslatedString DisplayString="@product.Description" TranslatedDisplayString="@translatedProduct?.Description" /></p>
                    }
                    @{
                        ProductBrand pb = product.Brands.FirstOrDefault(x => !string.IsNullOrWhiteSpace(x.Name));
                        if(pb != null)
                        {
                            <div class="brand-info">
                                <span class="brand-label">Márka:</span>
                                <span class="brand-name">@(pb != null ? pb.Name : "Ismeretlen")</span>
                            </div>
                        }
                    }

                    @if (!string.IsNullOrEmpty(product.Details?.Quantity))
                    {
                        <div class="quantity-badge">@product.Details.Quantity</div>
                    }

                    @{
                        if (product.Categories != null)
                        {
                            List<ProductCategory> categories = product.Categories.ToList();

                            void GetParentCategories(ProductCategory category)
                            {
                                if (category.ParentCategory != null)
                                {
                                    categories.Add(category.ParentCategory);
                                    translatedProduct?.Categories.Add(category.ParentCategory);
                                    GetParentCategories(category.ParentCategory);
                                }
                            }
                            foreach (var category in categories)
                            {
                                GetParentCategories(category);
                            }

                            if (categories.Count > 0)
                            {
                                <div class="categories-section">
                                <h4>Termékkategóriák</h4>
                                <div class="category-tree">
                                    @for (int i = 0; i < Math.Min(categories.Count, 6); i++)
                                    {
                                        <span class="category-tag"><TranslatedString DisplayString="@categories[i].Name" TranslatedDisplayString="@translatedProduct?.Categories.ElementAtOrDefault(i)?.Name" /></span>
                                    }
                                </div>
                            </div>                                
                            }
                        }
                    }

                    <!-- Quick Scores -->
                    <div class="quick-scores">
                        @if (product.Details?.NutriScore != NutriScore.Unknown)
                        {
                            <div class="score-card nutriscore">
                                <div class="score-header">
                                    <span class="score-label">Nutri-Score</span>
                                    <div class="info-tooltip" title="Tápérték minősége A-tól (legjobb) E-ig (legrosszabb)">ℹ️</div>
                                </div>
                                <div class="nutriscore-display">
                                    <div class="nutriscore-letters">
                                        @foreach (var letter in new[] { "A", "B", "C", "D", "E" })
                                        {
                                            <span class="nutriscore-letter @(letter == product.Details?.NutriScore.ToString() ? "active" : "") nutriscore-@letter.ToLower()">
                                                @letter
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        @if (product.Details?.NovaGroup > 0)
                        {
                            <div class="score-card nova">
                                <div class="score-header">
                                    <span class="score-label">Nova besorolás</span>
                                    <div class="info-tooltip" title="Élelmiszer feldolgozottsági szintje 1-től (minimális) 4-ig (ultrafel­dolgozott)">ℹ️</div>
                                </div>
                                <div class="nova-display nova-@product.Details.NovaGroup">
                                    <div class="nova-number">@product.Details.NovaGroup</div>
                                    <div class="nova-dots">
                                        @for (int i = 1; i <= 4; i++)
                                        {
                                            <div class="nova-dot @(i <= product.Details.NovaGroup ? "active" : "")"></div>
                                        }
                                    </div>
                                </div>
                                <p class="nova-description">@GetNovaGroupDescription(product.Details.NovaGroup)</p>
                            </div>
                        }

                        @if (product.Details?.EnergyKcal.HasValue == true)
                        {
                            <div class="score-card calories">
                                <div class="score-header">
                                    <span class="score-label">Energia</span>
                                    <span class="score-unit">100g</span>
                                </div>
                                <div class="calories-display">
                                    <span class="calories-number">@product.Details.EnergyKcal</span>
                                    <span class="calories-unit">kcal</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Detailed Information Tabs -->
            @if (showDetails)
            {
                <div class="info-tabs">
                    <div class="tab-nav">
                        @{
                            if (product.Details?.EnergyKcal != null || !string.IsNullOrEmpty(product.Details?.ServingSize) || product.Details?.FatLevel != null)
                            {
                                <button class="tab-btn @(activeTab == "nutrition" ? "active" : "")" @onclick='() => SetActiveTab("nutrition")'>
                                    🥗 Tápérték
                                </button>
                            }

                            if (product.ProductPerStore.Count > 0)
                            {
                                <button class="tab-btn @(activeTab == "stores" ? "active" : "")" @onclick='() => SetActiveTab("stores")'>
                                    🛒 Boltok
                                </button>
                            }

                            if (product.ProductIngredients.Count > 0 || product.Additives.Count > 0 || product.Allergens.Count > 0)
                            {
                                <button class="tab-btn @(activeTab == "ingredients" ? "active" : "")" @onclick='() => SetActiveTab("ingredients")'>
                                    🧪 Összetevők
                                </button>
                            }
                        
                            <button class="tab-btn @(activeTab == "processing" ? "active" : "")" @onclick='() => SetActiveTab("processing")'>
                                ⚙️ Feldolgozottság
                            </button>

                            <button class="tab-btn @(activeTab == "packaging" ? "active" : "")" @onclick='() => SetActiveTab("packaging")'>
                                ♻️ Csomagolás
                            </button>

                            if (product.ProductImages.Count > 0)
                            {
                                <button class="tab-btn @(activeTab == "images" ? "active" : "")" @onclick='() => SetActiveTab("images")'>
                                    📷 Képek
                                </button>
                            }
                        }
                    
                    </div>
                    <div class="tab-content">
                        @if (activeTab == "nutrition")
                        {
                            <div class="nutrition-panel">
                                @if (product.Details != null)
                                {
                                    <div class="nutrition-grid">
                                        <div class="nutrition-main">
                                            <h3>🥗 Tápérték</h3>
                                            <table class="nutrition-table">
                                                <thead>
                                                    <tr>
                                                        <th class="nutrient-header">Tápanyag</th>
                                                        <th class="value-header">Érték</th>
                                                        <th class="percent-header">NRV%</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (product.Details.EnergyKcal.HasValue)
                                                    {
                                                        <tr class="nutrition-row main">
                                                            <td class="nutrient-name">Energia</td>
                                                            <td class="nutrient-value">
                                                                @product.Details.EnergyKcal <span class="unit">kcal</span>
                                                            </td>
                                                            <td class="percent-dv">@CalculatePercentDV((double)product.Details.EnergyKcal, 2000)%</td>
                                                        </tr>
                                                    }
                                                    @foreach (var nutrient in GetNutrientData())
                                                    {
                                                        <tr class="nutrition-row @(nutrient.IsMain ? "main" : "sub")">
                                                            <td class="nutrient-name">@nutrient.Name</td>
                                                            <td class="nutrient-value">
                                                                @nutrient.Value <span class="unit">@nutrient.Unit</span>
                                                            </td>
                                                            <td class="percent-dv">
                                                                @if (nutrient.PercentDV.HasValue)
                                                                {
                                                                    @nutrient.PercentDV

                                                                    <span>%</span>
                                                                }
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>

                                            @if (product.Details.ServingSize is not null)
                                            {
                                                <div class="serving-info-card">
                                                    <h4>Adag információk</h4>
                                                    <p><strong>Ajánlott adag:</strong> @product.Details.ServingSize</p>
                                                    @{
                                                        var servingQuantity = GetFirstNumber(product.Details.ServingSize);
                                                        if (product.Details.EnergyKcal.HasValue && servingQuantity != 0)
                                                        {
                                                            var servingCalories = (product.Details.EnergyKcal * servingQuantity / 100).Value;
                                                            <p><strong>Kalória adagonként:</strong> @servingCalories.ToString("F0") kcal</p>
                                                        }
                                                    }

                                                </div>
                                            }
                                        </div>
                                        @{
                                            IEnumerable<System.Reflection.PropertyInfo> levels = product.Details.GetType()
                                            .GetProperties()
                                            .Where(x => x.PropertyType == typeof(NutrientLevel?));
                                            if (levels.Select(x => (NutrientLevel?)x.GetValue(product.Details)).Any(x => x.HasValue))
                                            {
                                                <div class="nutrient-levels">
                                                    <h4>Tápanyagszintek</h4>
                                                    <div class="levels-grid">
                                                        @foreach (var prop in levels)
                                                        {
                                                            var val = (NutrientLevel?)prop.GetValue(product.Details);
                                                            if (val.HasValue)
                                                            {
                                                                <div class='level-card level-@val'>
                                                                    <div class='level-icon'>@GetNutrientIcon(prop.Name)</div>
                                                                    <div class='level-info'>
                                                                        <span class='level-name'>@FormatNutrientName(prop.Name)</span>
                                                                        <span class='level-status level-@val'>@GetTranslatedNutritionLevel((NutrientLevel)val)</span>
                                                                    </div>
                                                                    <div class='level-bar'>
                                                                        <div class='level-progress level-@val' style='width: @GetLevelWidth((NutrientLevel)val)%'></div>
                                                                    </div>
                                                                </div>
                                                            }
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        }

                                    </div>
                                }
                            </div>
                        }
                        else if (activeTab == "stores")
                        {
                            <h3>Elérhető ezekben a boltokban</h3>
                            <div class="search-bar">
                                <span class="bi bi-search"></span>
                                <input @bind="SearchText" @bind:event="oninput" type="text" placeholder="Keress egy boltot ahol kapható a termék..." class="store-search-input" />
                            </div>
                            <div class="stores-panel">
                                @if (storeRoutes?.Count > 0)
                                {
                                    @foreach (var store in storeRoutes)
                                    {
                                        <StorePreview Store="store.Value.Store" Price="store.Value.Price" DiscountedPrice="store.Value.DiscountedPrice" Route="store.Key"></StorePreview>
                                    }
                                }
                                else if (storesWithoutRoute.Count > 0)
                                {
                                    @foreach (var store in storesWithoutRoute)
                                    {
                                        <StorePreview Store="store.Store" Price="store.Price" DiscountedPrice="store.DiscountedPrice"></StorePreview>
                                    }
                                }
                                else if (noStoreSearchResult)
                                {
                                    <div>Nem található ilyen bolt</div>
                                }
                                else
                                {
                                    @foreach (var store in product.ProductPerStore.Take(10))
                                    {
                                        <StorePreview Store="store.Store" Price="store.Price" DiscountedPrice="store.DiscountedPrice"></StorePreview>
                                    }
                                }
                            </div>

                            <p class="price-warning">*Az árak és információk tájékoztató jellegűek, nem minősülnek ajánlatnak. Az adatok üzletenként eltérhetnek, valamint a folyamatos frissítések ellenére is tartalmazhatnak pontatlanságokat.</p>
                        }
                        else if (activeTab == "ingredients")
                        {
                            <div class="ingredients-panel">
                                <div class="ingredients-main">
                                    <h3>🧪 Összetevők</h3>
                                    @if (!string.IsNullOrEmpty(product.Details.IngredientsText))
                                    {
                                        <div class="ingredients-text">
                                            @product.Details.IngredientsText
                                        </div>
                                    }

                                    @if (product.ProductIngredients?.Any() == true)
                                    {
                                        <div class="ingredients-analysis">
                                            <h4>Összetevő elemzés</h4>
                                            <div class="ingredients-chart">
                                                @foreach (var ingredient in product.ProductIngredients.Take(8))
                                                {
                                                    var percentage = ingredient.PercentEstimate ?? 0;
                                                    <div class="ingredient-bar">
                                                        <div class="ingredient-info">
                                                            <span class="ingredient-name">@ingredient.Ingredient.Name</span>
                                                            <span class="ingredient-percent">@(percentage > 0 ? $"{percentage:F1}%" : "~")</span>
                                                        </div>
                                                        <div class="progress-bar">
                                                            <div class="progress-fill" style="width: @Math.Max(percentage, 2)%"></div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }

                                    <!-- Analysis Tags -->
                                    <div class="ingredient-tags">
                                        @{
                                            IEnumerable<string> attributes = product.Attributes?.Select(x => x.Name);
                                            if (attributes.Contains("palm-oil-free") == true)
                                            {
                                                <span class="analysis-tag positive">🌿 Pálmaolajmentes</span>
                                            }
                                            if (attributes.Contains("vegan") == true)
                                            {
                                                <span class="analysis-tag positive">🌱 Vegán</span>
                                            }
                                            else if (attributes.Contains("maybe-vegan") == true)
                                            {
                                                <span class="analysis-tag warning">🌱? Lehet, hogy Vegán</span>
                                            }
                                            if (attributes.Contains("vegetarian") == true)
                                            {
                                                <span class="analysis-tag positive">🥬 Vegetáriánus</span>
                                            }
                                            else if (attributes.Contains("maybe-vegetarian") == true)
                                            {
                                                <span class="analysis-tag warning">🥬? Lehet, hogy vegetáriánus</span>
                                            }
                                        }

                                    </div>
                                </div>

                                <!-- Allergens & Additives -->
                                @{
                                    var allergens = product.Allergens?.Any() == true;
                                    var additives = product.Additives?.Any() == true;
                                    if (allergens || additives)
                                    {
                                        <div class="warnings-section">
                                            @if (allergens)
                                            {
                                                <div class="warning-card allergens">
                                                    <h4>⚠️ Allergének</h4>
                                                    <div class="warning-chips">
                                                        @foreach (var allergen in product.Allergens)
                                                        {
                                                            <span class="warning-chip allergen">@allergen.Name</span>
                                                        }
                                                    </div>
                                                    <p class="warning-note">Nyomokban tartalmazhat. Ellenőrizd a csomagolást a teljes információért.</p>
                                                </div>
                                            }

                                            @if (additives)
                                            {
                                                <div class="warning-card additives">
                                                    <h4>🧪 Adalékanyagok</h4>
                                                    <div class="additives-list">
                                                        @foreach (var additive in product.Additives.Take(10))
                                                        {
                                                            var additiveInfo = GetAdditiveInfo(additive.Name);
                                                            <AdditiveInfo Additive="additiveInfo" />
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        }
                        else if (activeTab == "processing")
                        {
                            <div class="processing-panel">
                                <div class="nova-detailed">
                                    <h3>⚙️ Élelmiszer feldolgozottsági szintje</h3>
                                    <div class="nova-scale">
                                        @for (int i = 1; i <= 4; i++)
                                        {
                                            <div class="nova-step @(i == product.Details.NovaGroup ? "active" : "")">
                                                <div class="nova-number-large">@i</div>
                                                <div class="nova-info">
                                                    <h4>@GetNovaGroupTitle(i)</h4>
                                                    <p>@GetNovaGroupDescription(i)</p>
                                                    @if (i == product.Details.NovaGroup)
                                                    {
                                                        <div class="current-indicator">← Ez a termék</div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                        else if (activeTab == "packaging")
                        {
                            <div class="packaging-panel">
                                @if (product.Packaging.Count > 0)
                                {
                                    <h3>♻️ Csomagolás</h3>
                                    <div class="packaging-grid">
                                        @foreach (var packaging in product.Packaging)
                                        {
                                            <div class="packaging-card">
                                                <div class="packaging-icon">@GetPackagingIcon(packaging.Part?.Name)</div>
                                                <div class="packaging-details">
                                                    <h4>@FormatPackagingName(packaging.Part?.Name)</h4>
                                                    <div class="packaging-specs">
                                                        <div class="spec-item">
                                                            <span class="spec-label">Anyag:</span>
                                                            <span class="spec-value">@FormatPackagingName(packaging.Material?.Name)</span>
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(packaging.QuantityPerUnit))
                                                        {
                                                            <div class="spec-item">
                                                                <span class="spec-label">Mennyiség:</span>
                                                                <span class="spec-value">@packaging.QuantityPerUnit</span>
                                                            </div>
                                                        }
                                                        <div class="spec-item">
                                                            <span class="spec-label">Újrahasznosítás:</span>
                                                            <span class="spec-value recycling">@(packaging.Recyclable == true ? "Újrahasznosítható" : "Nem újrahasznosítható")</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="recycling-indicator @(packaging.Recyclable == true ? "recyclable" : "non-recyclable")">
                                                    @(packaging.Recyclable == true ? "♻️" : "🗑️")
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="no-data">
                                        <div class="no-data-icon">📦</div>
                                        <h3>Nincs elérhető csomagolásinformáció</h3>
                                        <p>A csomagolás részletei még nem kerültek fel a adatbázisba.</p>
                                    </div>
                                }
                                <div class="environmental-impact">
                                    <h4>🌍 Környezeti hatás</h4>
                                    <div class="eco-tips">
                                        <div class="eco-tip">
                                            <span class="eco-icon">♻️</span>
                                            <span>Ne felejtsd el szétválogatni a csomagolóanyagokat a megfelelő újrahasznosításhoz</span>
                                        </div>
                                        <div class="eco-tip">
                                            <span class="eco-icon">🌱</span>
                                            <span>Fontold meg olyan termékek választását, amelyek minimális vagy újrahasznosítható csomagolásúak</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else if (activeTab == "images")
                        {
                            <div class="images-panel">
                                <h3>📷 Termék képek</h3>
                                <div class="image-gallery">
                                    @foreach (var image in product.ProductImages)
                                    {
                                        if (!string.IsNullOrEmpty(image.URL))
                                        {
                                            <div class="gallery-item">
                                                <img src="@image.URL" alt="a termék egy képe" class="gallery-image" @onclick='() => OpenImageModal(image.URL)' />
                                                <div class="image-label">@GetImageTypeText(image.ImageType)</div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="loader"><span></span></div>
            }

            <!-- Labels Section -->
            @if (product.Labels?.Any() == true)
            {
                <div class="labels-section">
                    <h3>🏷️ Termékcímkék</h3>
                    <div class="labels-grid">
                        @foreach (var label in product.Labels.Take(8))
                        {
                            <div class="label-card">
                                <div class="label-icon">@GetLabelIcon(label.Name)</div>
                                <span class="label-text">@System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(label.Name)</span>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }

    <!-- Image Modal -->
    @if (showImageModal && !string.IsNullOrEmpty(modalImageUrl))
    {
        <div class="image-modal" @onclick="CloseImageModal">
            <div class="modal-content @modalImageOrientation" @onclick:stopPropagation="true">
                <img src="@modalImageUrl" alt="Product Image" class="modal-image" @onload="OnModalImageLoaded" />
                <button class="modal-close" @onclick="CloseImageModal">✕</button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string? Barcode { get; set; }

    private CancellationTokenSource? debounceTokenSource;
    private Dictionary<int, int> storeRelevanceScores = new Dictionary<int, int>();
    private Dictionary<RouteToStore, int> routeToStoreId = new Dictionary<RouteToStore, int>();
    private SortedList<RouteToStore, ProductPerStore> storeRoutes;
    private List<ProductPerStore> storesWithoutRoute = new List<ProductPerStore>();

    private string searchText = string.Empty;

    public string SearchText
    {
        get => searchText;
        set
        {
            if (searchText == value) return;

            searchText = value ?? string.Empty;
            noStoreSearchResult = false;

            // Cancel the previous timer if the user is still typing
            debounceTokenSource?.Cancel();
            debounceTokenSource?.Dispose();

            // Start a new timer for this keystroke
            debounceTokenSource = new CancellationTokenSource();
            var token = debounceTokenSource.Token;

            _ = InvokeAsync(async () =>
            {
                try
                {
                    // Wait => If the user types again, this token gets cancelled
                    await Task.Delay(600, token);

                    // If we made it here without being cancelled, the user stopped typing
                    if (!token.IsCancellationRequested)
                    {
                        if (string.IsNullOrWhiteSpace(searchText))
                        {
                            storesWithoutRoute.Clear();
                            await LoadAllStores();
                        }
                        else
                        {
                            await SearchStores();
                        }

                        StateHasChanged();
                    }
                }
                catch (TaskCanceledException)
                {
                    
                }
            });
        }
    }

    private Product? product;
    private Product? translatedProduct;
    private bool isLoading = false;
    private string? errorMessage;
    private string searchBarcode = "";
    private string activeTab = "";
    private bool showImageModal = false;
    private string modalImageOrientation = "";
    private string? modalImageUrl;
    private bool isFromDatabase = false;
    private string? translation;
    private bool favourited { get; set; } = false;
    private List<Additive> AllAdditives = new();

    private List<(ProductPerStore productPerStore, double distance, double lat, double lon)> storesWithDistance = new();
    private LocationResult? userLocation;
    private bool noStoreSearchResult = false;
    private bool showDetails = false;

    protected override async Task OnInitializedAsync()
    {
        storeRoutes = new SortedList<RouteToStore, ProductPerStore>(GetStoreRouteComparer());
        if (!string.IsNullOrEmpty(Barcode))
        {
            searchBarcode = Barcode;
            await SearchProduct();
            userLocation = await LocationService.GetUserLocationAsync();
        }
    }

    private string RemoveDiacritics(string text)
    {
        if (string.IsNullOrWhiteSpace(text))
            return text;

        var normalizedString = text.Normalize(NormalizationForm.FormD);
        var stringBuilder = new StringBuilder();

        foreach (var c in normalizedString)
        {
            var unicodeCategory = CharUnicodeInfo.GetUnicodeCategory(c);
            if (unicodeCategory != UnicodeCategory.NonSpacingMark)
            {
                stringBuilder.Append(c);
            }
        }

        return stringBuilder.ToString().Normalize(NormalizationForm.FormC);
    }

    private async Task SearchProduct()
    {
        if (string.IsNullOrWhiteSpace(searchBarcode)) return;

        DateTime dateTime = DateTime.Now;
        isLoading = true;
        errorMessage = null;
        product = null;
        isFromDatabase = false;
        StateHasChanged();

        try
        {
            var dbProduct = await ProductService.GetProductAsync(searchBarcode.Trim());

            if (dbProduct != null)
            {
                product = dbProduct;
                translatedProduct = new();
                Console.WriteLine($"Whole product get: {DateTime.Now - dateTime}");

                // Start independent background fetches SAFELY on the Blazor context (No Task.Run)
                _ = FetchRestAndSortAsync();
                _ = LoadAdditivesAsync();
            }
            else
            {
                errorMessage = "A termék nem található az adatbázisban. Kérjük, ellenőrizze a vonalkódot, és próbálja újra.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred while searching for the product: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task FetchRestAndSortAsync()
    {
        // 1. Fully populate the store list FIRST (no more collection modified errors)
        try
        {
            await ProductService.AttachRestAsync(product);
        }
        catch
        {
            return;
        }
        finally
        {
            activeTab = product.Details?.EnergyKcal != null || !string.IsNullOrEmpty(product.Details?.ServingSize) || product.Details?.FatLevel != null ? "nutrition" : "processing";
            showDetails = true;
        }

        // 2. Make absolutely sure we have the location before trying to sort
        if (userLocation == null)
        {
            userLocation = await LocationService.GetUserLocationAsync();
        }

        // 3. Now that the list is populated AND location is ready, safely sort and render!
        if (userLocation != null && product?.ProductPerStore?.Count > 0)
        {
            await SortStoresByAirDistance();
            await LoadAllStores();
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task AttachRestToProduct()
    {
        try
        {
            await ProductService.AttachRestAsync(product);
        }
        catch
        {
            return;
        }
        finally
        {
            activeTab = product.Details?.EnergyKcal != null || !string.IsNullOrEmpty(product.Details?.ServingSize) || product.Details?.FatLevel != null ? "nutrition" : "processing";
            showDetails = true;
        }

        await SortStoresByAirDistance();
        await LoadAllStores();
        await InvokeAsync(StateHasChanged);
    }

    private async Task SortStoresByAirDistance()
    {
        if (userLocation == null) return;
        storesWithDistance = new();

        foreach (var store in product.ProductPerStore)
        {
            // Parse Safely Once
            if (double.TryParse(store.Store.Latitude, NumberStyles.Any, CultureInfo.InvariantCulture, out double lat)
                && double.TryParse(store.Store.Longitude, NumberStyles.Any, CultureInfo.InvariantCulture, out double lon))
            {
                double airDistance = LocationService.CalculateDistance(
                    userLocation.Latitude,
                    userLocation.Longitude,
                    lat,
                    lon
                );

                // Cache parsed coordinates so we don't have to parse them again
                storesWithDistance.Add((store, airDistance, lat, lon));
            }
        }

        storesWithDistance = storesWithDistance
            .OrderBy(x => x.distance)
            .ToList();
    }

    // Updated Signature and Progressive Logic
    private async Task SortStores(List<(ProductPerStore productPerStore, double distance, int relevanceScore, double lat, double lon)> closestStores)
    {
        if (userLocation == null || closestStores.Count == 0) return;

        // PHASE 1: Display the fallback math instantly
        storeRelevanceScores.Clear();
        routeToStoreId.Clear();
        var estimatedRoutes = new SortedList<RouteToStore, ProductPerStore>(storeRoutes.Comparer);

        var validStores = new List<(ProductPerStore productPerStore, double distance)>();
        var destinations = new List<(double Lat, double Lon)>();

        foreach (var storeData in closestStores)
        {
            storeRelevanceScores[storeData.productPerStore.Store.Id] = storeData.relevanceScore;

            double estimatedRoadDistance = storeData.distance * 1.3;
            double estimatedDurationMin = (estimatedRoadDistance / 35.0) * 60.0;

            var estimatedRoute = new RouteToStore
            {
                Distance = Math.Round(estimatedRoadDistance, 1),
                Duration = Math.Round(estimatedDurationMin)
            };

            while (routeToStoreId.ContainsKey(estimatedRoute))
            {
                estimatedRoute.Distance += 0.01;
            }

            routeToStoreId[estimatedRoute] = storeData.productPerStore.Store.Id;
            estimatedRoutes.Add(estimatedRoute, storeData.productPerStore);

            validStores.Add((storeData.productPerStore, storeData.distance));
            destinations.Add((storeData.lat, storeData.lon));
        }

        storeRoutes = estimatedRoutes;
        await InvokeAsync(StateHasChanged);

        // PHASE 2: Make the single bulk API call and update UI precisely
        var bulkRoutes = await LocationService.GetBulkRouteInfoAsync(userLocation.Latitude, userLocation.Longitude, destinations);

        if (bulkRoutes != null && bulkRoutes.Count == validStores.Count)
        {
            var preciseRoutes = new SortedList<RouteToStore, ProductPerStore>(storeRoutes.Comparer);
            routeToStoreId.Clear();

            for (int i = 0; i < validStores.Count; i++)
            {
                var storeData = validStores[i];
                RouteToStore finalRoute;

                if (bulkRoutes[i] != null)
                {
                    finalRoute = bulkRoutes[i];
                }
                else
                {
                    double estDist = storeData.distance * 1.3;
                    double estDur = (estDist / 35.0) * 60.0;
                    finalRoute = new RouteToStore { Distance = Math.Round(estDist, 1), Duration = Math.Round(estDur) };
                }

                while (routeToStoreId.ContainsKey(finalRoute))
                {
                    finalRoute.Distance += 0.01;
                }

                routeToStoreId[finalRoute] = storeData.productPerStore.Store.Id;
                preciseRoutes.Add(finalRoute, storeData.productPerStore);
            }

            storeRoutes = preciseRoutes;
            await InvokeAsync(StateHasChanged);
        }
    }

    class StoreSearchResult
    {
        public ProductPerStore ProductPerStore { get; set; }
        public double Distance { get; set; }
        public int RelevanceScore { get; set; }
        public double Lat { get; set; }
        public double Lon { get; set; }
    }

    private async Task SearchStores()
    {
        if (product?.ProductPerStore == null || product.ProductPerStore.Count == 0)
        {
            storesWithoutRoute.Clear();
            storeRoutes?.Clear();
            noStoreSearchResult = true;
            return;
        }

        if (storeRoutes == null)
        {
            storeRoutes = new SortedList<RouteToStore, ProductPerStore>(GetStoreRouteComparer());
        }
        else
        {
            storeRoutes.Clear();
        }

        routeToStoreId.Clear();
        storeRelevanceScores.Clear();
        storesWithoutRoute.Clear();
        noStoreSearchResult = false;

        var normalizedSearch = RemoveDiacritics(searchText.ToLowerInvariant());
        var searchTokens = normalizedSearch
            .Split(new[] { ' ', ',', '-' }, StringSplitOptions.RemoveEmptyEntries)
            .Where(t => t.Length > 0)
            .ToArray();

        if (storesWithDistance.Count > 0)
        {
            var closestStoresWithSearch = storesWithDistance
                .Select(x =>
                {
                    var store = x.productPerStore.Store;
                    var storeBrand = RemoveDiacritics((store.StoreBrand?.Name ?? string.Empty).ToLowerInvariant());
                    var address = RemoveDiacritics((store.Address ?? string.Empty).ToLowerInvariant());

                    string city = string.Empty;
                    try
                    {
                        var addressParts = store.Address?.Split(' ');
                        if (addressParts is { Length: > 1 })
                        {
                            city = RemoveDiacritics(addressParts[1].TrimEnd(',').ToLowerInvariant());
                        }
                    }
                    catch { }

                    var fullText = $"{storeBrand} {address} {city}";

                    int relevanceScore = CalculateRelevanceScore(
                        storeBrand, address, city, fullText, searchTokens, normalizedSearch);

                    return new StoreSearchResult
                    {
                        ProductPerStore = x.productPerStore,
                        Distance = x.distance,
                        RelevanceScore = relevanceScore,
                        Lat = x.lat,
                        Lon = x.lon
                    };
                })
                .Where(x => x.RelevanceScore > 0)
                .OrderByDescending(x => x.RelevanceScore)
                .ThenBy(x => x.Distance)
                .Take(10)
                // Pass down Lat and Lon
                .Select(x => (x.ProductPerStore, x.Distance, x.RelevanceScore, x.Lat, x.Lon))
                .ToList();

            if (closestStoresWithSearch.Count == 0)
            {
                var comparer = storeRoutes.Comparer;
                storeRoutes = new SortedList<RouteToStore, ProductPerStore>(comparer);
                noStoreSearchResult = true;
                return;
            }

            await SortStores(closestStoresWithSearch);
        }
        else
        {
            var storesWithRelevance = product.ProductPerStore
                .Select(x =>
                {
                    var store = x.Store;
                    var storeBrand = RemoveDiacritics((store.StoreBrand?.Name ?? string.Empty).ToLowerInvariant());
                    var address = RemoveDiacritics((store.Address ?? string.Empty).ToLowerInvariant());

                    string city = string.Empty;
                    try
                    {
                        var addressParts = store.Address?.Split(' ');
                        if (addressParts is { Length: > 1 })
                        {
                            city = RemoveDiacritics(addressParts[1].TrimEnd(',').ToLowerInvariant());
                        }
                    }
                    catch { }

                    var fullText = $"{storeBrand} {address} {city}";

                    int relevanceScore = CalculateRelevanceScore(
                        storeBrand, address, city, fullText, searchTokens, normalizedSearch);

                    return new StoreSearchResult
                    {
                        ProductPerStore = x,
                        RelevanceScore = relevanceScore
                    };
                })
                .Where(x => x.RelevanceScore > 0)
                .OrderByDescending(x => x.RelevanceScore)
                .ThenBy(x => x.ProductPerStore.Store.Id)
                .Take(10)
                .ToList();

            foreach (var storeWithRelevance in storesWithRelevance)
            {
                storesWithoutRoute.Add(storeWithRelevance.ProductPerStore);
            }

            if (storesWithoutRoute.Count == 0)
            {
                noStoreSearchResult = true;
            }
        }
    }

    private async Task LoadAllStores()
    {
        if (storeRoutes == null)
        {
            storeRoutes = new SortedList<RouteToStore, ProductPerStore>(GetStoreRouteComparer());
        }
        else
        {
            storeRoutes.Clear();
        }

        routeToStoreId.Clear();
        storeRelevanceScores.Clear();
        storesWithoutRoute.Clear();
        noStoreSearchResult = false;

        if (storesWithDistance.Count > 0)
        {
            var closestStores = storesWithDistance
                .OrderBy(x => x.distance)
                // Map the cached coordinates through
                .Select(x => (x.productPerStore, x.distance, 0, x.lat, x.lon))
                .Take(10)
                .ToList();

            await SortStores(closestStores);
        }
    }

    private async Task GetTranslations()
    {
        translatedProduct.Description = await TranslateAsync(product.Description);
        translatedProduct.Categories = await Translate4N(product.Categories);
        await InvokeAsync(StateHasChanged);
    }

    private async Task<ICollection<T>> Translate4N<T>(ICollection<T> fromCollection) where T : class, INToNTable
    {
        List<T> collection = new List<T>();
        foreach (var i in fromCollection)
        {
            var obj = (T)Activator.CreateInstance(typeof(T));
            obj.Name = await TranslateAsync(i.Name);
            collection.Add(obj);
        }
        return collection;
    }

    private async Task<string?> TranslateAsync(string stringToTranslate)
    {
        var url = "https://translate.shopscout.me/translate";
        var apiKey = Environment.GetEnvironmentVariable("API_KEY");
        var json = $@"{{
            ""q"": ""{stringToTranslate}"",
            ""source"": ""auto"",
            ""target"": ""hu"",
            ""format"": ""text"",
            ""api_key"": ""{apiKey}""
        }}";

        var content = new StringContent(json, Encoding.UTF8, "application/json");
        var response = await _client.PostAsync(url, content);
        if (!response.IsSuccessStatusCode) return null;

        var result = await response.Content.ReadFromJsonAsync<Dictionary<string, object>>();
        return result["translatedText"] != null ? result["translatedText"].ToString() : null;
    }

    private void SearchExample(string barcode)
    {
        NavigationManager.NavigateTo($"/product/{barcode}");
    }

    private async Task ShowSearchForm()
    {
        string searchTerm = await LocalStorageService.GetValue<string>("prevUrl", "");
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            await LocalStorageService.SetValue("prevUrl", "");
            NavigationManager.NavigateTo($"/search/{searchTerm}", true);
        }
        else
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private void SearchForBarcode()
    {
        NavigationManager.NavigateTo($"/product/{searchBarcode}");
    }

    private void GoToReader()
    {
        NavigationManager.NavigateTo("/reader");
    }

    private async Task OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            SearchForBarcode();
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private void OpenImageModal(string imageUrl)
    {
        modalImageUrl = imageUrl;
        modalImageOrientation = "";
        showImageModal = true;
    }

    private void CloseImageModal()
    {
        showImageModal = false;
        modalImageUrl = null;
        modalImageOrientation = "";
    }

    private async Task OnModalImageLoaded()
    {
        var orientation = await JS.InvokeAsync<string>("eval", @"
            (function() {
                var img = document.querySelector('.modal-image');
                if (!img) return 'landscape';
                return img.naturalWidth >= img.naturalHeight ? 'landscape' : 'portrait';
            })()
        ");
        modalImageOrientation = orientation;
        StateHasChanged();
    }

    private int CalculateRelevanceScore(
        string storeBrand, string address, string city, string fullText, string[] searchTokens, string originalSearch)
    {
        int score = 0;

        if (storeBrand == originalSearch) score += 1000;
        if (address == originalSearch) score += 900;
        if (city == originalSearch) score += 800;

        if (storeBrand.StartsWith(originalSearch)) score += 700;
        if (address.StartsWith(originalSearch)) score += 600;
        if (city.StartsWith(originalSearch)) score += 500;

        if (storeBrand.Contains(originalSearch)) score += 400;
        if (address.Contains(originalSearch)) score += 300;
        if (city.Contains(originalSearch)) score += 200;

        foreach (var token in searchTokens)
        {
            if (storeBrand.StartsWith(token)) score += 100;
            if (address.StartsWith(token)) score += 80;
            if (city.StartsWith(token)) score += 60;

            if (storeBrand.Contains(token)) score += 50;
            if (address.Contains(token)) score += 40;
            if (city.Contains(token)) score += 30;
        }

        int matchedTokens = searchTokens.Count(token => fullText.Contains(token));
        score += matchedTokens * 20;

        if (searchTokens.Length > 0 && searchTokens.All(token => fullText.Contains(token)))
        {
            score += 200;
        }

        return score;
    }

    // Helper methods
    private string GetNovaGroupTitle(int group)
    {
        return group switch
        {
            1 => "Feldolgozatlan vagy minimálisan feldolgozott élelmiszerek",
            2 => "Feldolgozott alapanyagok, konyhai összetevők",
            3 => "Feldolgozott élelmiszerek",
            4 => "Ultrafeldolgozott élelmiszerek",
            _ => "Ismeretlen"
        };
    }

    private string GetNovaGroupDescription(int group)
    {
        return group switch
        {
            1 => "Természetes élelmiszerek minimális feldolgozással, például friss gyümölcsök, zöldségek, magvak, tojás és friss hús.",
            2 => "Természetes élelmiszerekből kivont alapanyagok, például olajok, vaj, cukor és só.",
            3 => "Egyszerűen feldolgozott élelmiszerek, amelyeket hozzávalók hozzáadásával készítenek, például konzerv zöldségek, sajt és kenyér.",
            4 => "Ultrafeldolgozott élelmiszerek sok mesterséges összetevővel, például üdítők, kekszek és instant élelmiszerek.",
            _ => "A feldolgozottsági szint nem meghatározott"
        };
    }

    private string FormatNutrientName(string name)
    {
        return name.ToLower().Replace("level", "") switch
        {
            "saturatedfat" => "Telített zsírsavak",
            "salt" => "Só",
            "sugars" => "Cukor",
            "fat" => "Zsír",
            _ => System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(name.Replace("-", " "))
        };
    }

    private string GetNutrientIcon(string nutrient)
    {
        return nutrient.ToLower().Replace("level", "") switch
        {
            "fat" => "🧈",
            "saturatedfat" => "🥩",
            "sugars" => "🍯",
            "salt" => "🧂",
            _ => "📊"
        };
    }

    private string GetTranslatedNutritionLevel(NutrientLevel level)
    {
        return level.ToString().ToUpper() switch
        {
            "LOW" => "ALACSONY",
            "MODERATE" => "KÖZEPES",
            "HIGH" => "MAGAS",
            _ => "UNKNOWN"
        };
    }

    private string GetImageTypeText(ProductImageType type)
    {
        return type switch
        {
            ProductImageType.Primary => "Termék eleje",
            ProductImageType.Nutrition => "Tápértékadatok",
            ProductImageType.Packaging => "Csomagolás",
            ProductImageType.Ingredients => "Összetevők",
            _ => "Ismeretlen"
        };
    }

    private double GetLevelWidth(NutrientLevel level)
    {
        return level.ToString().ToUpper() switch
        {
            "LOW" => 33,
            "MODERATE" => 66,
            "HIGH" => 100,
            _ => 0
        };
    }

    private string FormatPackagingName(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "Unknown";
        var formatted = name.Replace("en:", "").Replace("-", " ").Replace("_", " ");
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(formatted);
    }

    private string GetPackagingIcon(string? shape)
    {
        return shape?.ToLower() switch
        {
            var s when s?.Contains("bottle") == true => "🍼",
            var s when s?.Contains("can") == true => "🥫",
            var s when s?.Contains("box") == true => "📦",
            var s when s?.Contains("bag") == true => "👜",
            var s when s?.Contains("jar") == true => "🫙",
            var s when s?.Contains("cap") == true => "🔘",
            var s when s?.Contains("lid") == true => "🔴",
            _ => "📦"
        };
    }

    private string GetLabelIcon(string label)
    {
        return label.ToLower() switch
        {
            var l when l.Contains("organic") => "🌿",
            var l when l.Contains("fair") => "⚖️",
            var l when l.Contains("gluten") => "🌾",
            var l when l.Contains("vegan") => "🌱",
            var l when l.Contains("vegetarian") => "🥬",
            var l when l.Contains("halal") => "☪️",
            var l when l.Contains("kosher") => "✡️",
            var l when l.Contains("bio") => "🧬",
            var l when l.Contains("natural") => "🍃",
            _ => "🏷️"
        };
    }

    private List<NutrientData> GetNutrientData()
    {
        var nutrients = new List<NutrientData>();

        if (product?.Details == null) return nutrients;

        if (product.Details.Fat.HasValue)
        {
            nutrients.Add(new NutrientData
            {
                Name = "Zsír",
                Value = product.Details.Fat.Value,
                Unit = "g",
                IsMain = true,
                PercentDV = CalculatePercentDV(product.Details.Fat.Value, 70)
            });
        }

        if (product.Details.SaturatedFat.HasValue)
        {
            nutrients.Add(new NutrientData
            {
                Name = "Amelyből telített zsírsavak",
                Value = product.Details.SaturatedFat.Value,
                Unit = "g",
                IsMain = false,
                PercentDV = CalculatePercentDV(product.Details.SaturatedFat.Value, 20)
            });
        }

        if (product.Details.Carbohydrates.HasValue)
        {
            nutrients.Add(new NutrientData
            {
                Name = "Szénhidrát",
                Value = product.Details.Carbohydrates.Value,
                Unit = "g",
                IsMain = true,
                PercentDV = CalculatePercentDV(product.Details.Carbohydrates.Value, 260)
            });
        }

        if (product.Details.Sugars.HasValue)
        {
            nutrients.Add(new NutrientData
            {
                Name = "Amelyből Cukrok",
                Value = product.Details.Sugars.Value,
                Unit = "g",
                IsMain = false,
                PercentDV = CalculatePercentDV(product.Details.Sugars.Value, 90)
            });
        }

        if (product.Details.Proteins.HasValue)
        {
            nutrients.Add(new NutrientData
            {
                Name = "Fehérje",
                Value = product.Details.Proteins.Value,
                Unit = "g",
                IsMain = true,
                PercentDV = CalculatePercentDV(product.Details.Proteins.Value, 50)
            });
        }

        if (product.Details.Salt.HasValue)
        {
            nutrients.Add(new NutrientData
            {
                Name = "Só",
                Value = product.Details.Salt.Value,
                Unit = "g",
                IsMain = true,
                PercentDV = CalculatePercentDV(product.Details.Salt.Value, 6)
            });
        }

        return nutrients;
    }

    private int? CalculatePercentDV(double value, double dailyValue)
    {
        return (int)Math.Round((value / dailyValue) * 100);
    }

    private async Task LoadAdditivesAsync()
    {
        var data = await _client.GetStringAsync("https://app.shopscout.me/additives.json");
        var jsonDoc = JsonDocument.Parse(data);
        var categories = jsonDoc.RootElement.GetProperty("categories");

        foreach (var category in categories.EnumerateArray())
        {
            var categoryName = category.GetProperty("name").GetString();
            var items = category.GetProperty("items");

            foreach (var item in items.EnumerateArray())
            {
                AllAdditives.Add(new Additive
                {
                    Code = item.GetProperty("code").GetString(),
                    Name = item.GetProperty("name").GetString(),
                    Description = item.GetProperty("description").GetString(),
                    Type = categoryName,
                    Risk = (AdditiveRiskLevel)item.GetProperty("safety_level").GetInt32()
                });
            }
        }
        await InvokeAsync(StateHasChanged);
    }

    private Additive GetAdditiveInfo(string additiveCode)
    {
        var additive = AllAdditives.FirstOrDefault(a => a.Code.Equals(additiveCode, StringComparison.OrdinalIgnoreCase));
        if (additive == null)
        {
            additive = AllAdditives.FirstOrDefault(a => a.Code.Equals(additiveCode[..^1], StringComparison.OrdinalIgnoreCase));
        }

        if (additive == null)
        {
            additive = new()
            {
                Code = additiveCode,
                Name = additiveCode,
                Type = "Élelmiszer-adalékanyag",
                Description = "",
                Risk = AdditiveRiskLevel.Unknown
            };
        }

        return additive;
    }

    public static double GetFirstNumber(string input)
    {
        if (string.IsNullOrEmpty(input))
            return 0;

        int endIndex = 0;
        for (int i = 0; i < input.Length; i++)
        {
            if (char.IsDigit(input[i]) || input[i] == '.')
                endIndex = i + 1;
            else
                break;
        }

        if (endIndex > 0)
        {
            string numberPart = input.Substring(0, endIndex);
            if (double.TryParse(numberPart, out double result))
            {
                return result;
            }
        }

        return 0;
    }

    private Comparer<RouteToStore> GetStoreRouteComparer()
    {
        return Comparer<RouteToStore>.Create((x, y) =>
        {
            int relevanceX = routeToStoreId.TryGetValue(x, out int storeIdX)
                ? storeRelevanceScores.GetValueOrDefault(storeIdX, 0)
                : 0;
            int relevanceY = routeToStoreId.TryGetValue(y, out int storeIdY)
                ? storeRelevanceScores.GetValueOrDefault(storeIdY, 0)
                : 0;

            bool hasRelevance = relevanceX > 0 || relevanceY > 0;

            if (hasRelevance)
            {
                int relevanceCompare = relevanceY.CompareTo(relevanceX);
                if (relevanceCompare != 0) return relevanceCompare;

                bool xLoaded = x.Duration >= 0;
                bool yLoaded = y.Duration >= 0;

                if (xLoaded && !yLoaded) return -1;
                if (!xLoaded && yLoaded) return 1;

                if (!xLoaded && !yLoaded)
                {
                    return x.Distance.CompareTo(y.Distance);
                }

                int durationCompare = x.Duration.CompareTo(y.Duration);
                if (durationCompare != 0) return durationCompare;
            }
            else
            {
                int durationCompare = x.Duration.CompareTo(y.Duration);
                if (durationCompare != 0) return durationCompare;
            }

            int distanceCompare = x.Distance.CompareTo(y.Distance);
            if (distanceCompare != 0) return distanceCompare;

            return x.GetHashCode().CompareTo(y.GetHashCode());
        });
    }

    private Comparer<int> GetRelevanceComparer()
    {
        return Comparer<int>.Create((x, y) =>
        {
            int comparison = y.CompareTo(x);
            if (comparison != 0)
            {
                return comparison;
            }

            return x.GetHashCode().CompareTo(y.GetHashCode());
        });
    }

    public class NutrientData
    {
        public string Name { get; set; } = "";
        public double Value { get; set; }
        public string Unit { get; set; } = "";
        public bool IsMain { get; set; }
        public int? PercentDV { get; set; }
    }
}