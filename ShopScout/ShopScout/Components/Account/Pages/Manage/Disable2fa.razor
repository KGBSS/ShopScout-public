@page "/Account/Manage/Disable2fa"

@using Microsoft.AspNetCore.Identity
@using ShopScout.Data
@using ShopScout.SharedLib.Models

@inject UserManager<ApplicationUser> UserManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject ILogger<Disable2fa> Logger

<PageTitle>Kétfaktoros hitelesítés kikapcsolása</PageTitle>

<div class="content-wrapper">
    <StatusMessage />

    <div class="card card-red">
        <div class="section-header">
            <div class="icon-circle icon-circle-red">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </div>
            <div>
                <h3 class="section-title section-title-red">Kétfaktoros hitelesítés kikapcsolása</h3>
                <p class="section-description section-description-red">Ez a művelet véglegesen törli a 2FA beállításokat</p>
            </div>
        </div>

        <div class="info-box info-box-red">
            <ul>
                <li>
                    <span class="bullet bullet-red">•</span>
                    <span><strong>Minden 2FA-hoz kapcsolódó adat törlődik:</strong> hitelesítő kulcsok, helyreállítási kódok és beállítások.</span>
                </li>
                <li>
                    <span class="bullet bullet-red">•</span>
                    <span>A hitelesítő alkalmazásodban (pl. Google Authenticator) lévő ShopScout bejegyzés <strong>nem fog többé működni</strong>.</span>
                </li>
                <li>
                    <span class="bullet bullet-red">•</span>
                    <span>Ha újra engedélyezed a 2FA-t, <strong>teljesen új beállítást</strong> kell végezned: új QR kód, új kulcsok, új helyreállítási kódok.</span>
                </li>
                <li>
                    <span class="bullet bullet-red">•</span>
                    <span>A 2FA kikapcsolása után a fiókod <strong>csak jelszóval védett</strong>, ami kevésbé biztonságos.</span>
                </li>
            </ul>
        </div>

        <form @formname="disable-2fa" @onsubmit="OnSubmitAsync" method="post">
            <AntiforgeryToken />
            <button class="btn-delete" type="submit">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                2FA kikapcsolása
            </button>
        </form>
    </div>

    <div class="notice-card">
        <p class="notice-text">
            <strong>Biztonsági tipp:</strong> A kétfaktoros hitelesítés további védelmi réteget biztosít a fiókod számára. Csak akkor kapcsold ki, ha feltétlenül szükséges.
        </p>
    </div>
</div>

@code {
    private ApplicationUser user = default!;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        NavBarService.SetNavBar("Kétfaktoros hitelesítés kikapcsolása", "/Account/Manage/AccountSecurity");
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);

        if (HttpMethods.IsGet(HttpContext.Request.Method) && !await UserManager.GetTwoFactorEnabledAsync(user))
        {
            throw new InvalidOperationException("Cannot disable 2FA for user as it's not currently enabled.");
        }
    }

    private async Task OnSubmitAsync()
    {
        var disable2faResult = await UserManager.SetTwoFactorEnabledAsync(user, false);
        if (!disable2faResult.Succeeded)
        {
            throw new InvalidOperationException("Unexpected error occurred disabling 2FA.");
        }

        var userId = await UserManager.GetUserIdAsync(user);
        Logger.LogInformation("User with ID '{UserId}' has disabled 2fa.", userId);
        RedirectManager.RedirectToWithStatus(
            "Account/Manage/AccountSecurity",
            "A 2FA kikapcsolva. Újra engedélyezheted a 2FA-t egy hitelesítő alkalmazás beállításával.",
            HttpContext);
    }
}