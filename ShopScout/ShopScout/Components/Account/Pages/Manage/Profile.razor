@page "/Account/Manage/Profile"
@using System.ComponentModel.DataAnnotations
@using System.Globalization
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using ShopScout.Client.Layout
@using ShopScout.Data
@using ShopScout.Services
@using ShopScout.SharedLib.Models

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject Services.IEmailSender EmailSender
@inject ILogger<Profile> Logger
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject NavigationManager NavigationManager

<StatusMessage Message="@message" />
<div class="content-wrapper">
    <div class="card">
        <div class="avatar-section">
            <div class="avatar" id="avatar">J</div>
            <button class="edit-btn" id="editBtn" onclick="toggleEdit()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Profil szerkesztése
            </button>
        </div>
        
        <EditForm Model="Input" FormName="profile" id="profileForm" OnValidSubmit="OnValidSubmitAsync" method="post">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            <div class="mb-3">
                <label for="email" class="form-label">E-mail</label>
                <InputText @bind-Value="Input.Email" id="Input.Email" class="form-control" autocomplete="email" aria-required="true" placeholder="Enter your email address" disabled />
            </div>

            <div class="mb-3">
                <label for="username" class="form-label">Felhasználónév</label>
                <InputText @bind-Value="Input.DisplayName" id="Input.DisplayName" class="form-control" placeholder="Enter a display name" disabled />
            </div>
            <div class="btn-group-custom hidden" id="actionButtons">
                <button class="btn-save" type="submit">
                    <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Mentés
                </button>
                <button class="btn-cancel" onclick="cancelEdit()" type="button">
                    <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Elvet
                </button>
            </div>
        </EditForm>
        
    </div>

    <a href="/account/personalization" class="search-btn">
        Élmény személyre szabása
        <div class="btn-shine"></div>
    </a>

    <div class="card">
        <div class="info-section">
            <h3>Fiók adatai</h3>
            <div>
                <div class="info-item">
                    <svg class="info-icon-circle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <div>
                        <p class="info-label">Regisztrált</p>
                        <p class="info-value">@(memberSince.ToString("D", new CultureInfo("hu-HU")))</p>
                    </div>
                </div>
                <hr class="separator">
                <div class="info-item">
                    <svg class="info-icon-circle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    <div>
                        <p class="info-label">Email-cím</p>
                        <p class="info-value">
                            @if (!isEmailConfirmed)
                            {
                                <span>Nincs megerősítve</span>
                            }
                            else
                            {
                                <span>Megerősítve</span>
                            }
                        </p>
                    </div>
                    @if (!isEmailConfirmed)
                    {
                        <div class="right">
                            <form @onsubmit="OnSendEmailVerificationAsync" @formname="send-verification" id="send-verification-form" method="post">
                                <AntiforgeryToken />
                                <button class="btn-connect" type="submit">Visszaigazoló email küldése</button>
                            </form>
                        </div>
                    }
                </div>
                <hr class="separator">
                <div class="info-item">
                    <svg class="info-icon-circle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <div>
                        <p class="info-label">Utolsó belépés</p>
                        <p class="info-value">@(lastLogin.ToString("f", new CultureInfo("hu-HU")))</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notice-card">
        <p class="notice-text">
            <strong>Adatvédelmi tájékoztató:</strong> A profiladataid bizalmasak, és csak számodra láthatóak.
        </p>
    </div>
</div>

@code {
    private string? message;
    private ApplicationUser user = default!;
    private string? email;
    private string? displayName;
    private DateTime memberSince;
    private DateTime lastLogin;
    private bool isEmailConfirmed;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm(FormName = "profile")]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        NavBarService.SetNavBar("Profil", "/account/manage");

        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        email = await UserManager.GetEmailAsync(user);
        displayName = await UserManager.GetUserNameAsync(user);
        isEmailConfirmed = await UserManager.IsEmailConfirmedAsync(user);
        memberSince = (DateTime)user.RegistrationDate;
        lastLogin = (DateTime)user.LastLoginTime;

        Input.Email ??= email;
        Input.DisplayName ??= displayName;
    }

    private async Task OnValidSubmitAsync()
    {
        if (string.IsNullOrEmpty(Input.Email)) return;
        if (string.IsNullOrEmpty(Input.DisplayName)) return;

        if (Input.Email != email)
        {

            var callbackUrl = await GetCallbackUrl();
            await EmailSender.SendConfirmationLinkAsync(Input.Email, HtmlEncoder.Default.Encode(callbackUrl));

            message = "A megerősítő email elküldve! Kérlek nyomj az email-ben található gombra, ellenőrizd a spam mappát is.";
            Logger.LogInformation("Verification email sent to: {user}", email);
        }
        if (Input.DisplayName != displayName)
            await UserManager.SetUserNameAsync(user, Input.DisplayName);

        await SignInManager.RefreshSignInAsync(user);
        //RedirectManager.RedirectToCurrentPageWithStatus("Your profile has been updated", HttpContext);
    }

    private async Task OnSendEmailVerificationAsync()
    {
        if (email is null)
        {
            return;
        }

        var callbackUrl = await GetCallbackUrl();

        await EmailSender.SendConfirmationLinkAsync(email, HtmlEncoder.Default.Encode(callbackUrl));

        message = "A megerősítő email elküldve! Kérlek nyomj az email-ben található gombra, ellenőrizd a spam mappát is.";
        Logger.LogInformation("Verification email sent to: {user}", email);
    }

    private async Task<string> GetCallbackUrl()
    {
        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateChangeEmailTokenAsync(user, Input.Email);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));

        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmailChange").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["email"] = Input.Email, ["code"] = code });

        return callbackUrl;
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        [Display(Name = "Email")]
        public string? Email { get; set; }

        [Display(Name = "Display Name")]
        public string? DisplayName { get; set; }
    }
}