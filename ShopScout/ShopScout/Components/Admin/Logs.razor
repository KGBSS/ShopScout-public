@page "/admin/logs"
@layout AdminLayout
@rendermode InteractiveServer
@using ShopScout.Services
@using ShopScout.Models
@inject LogService LogSvc

<div class="h-100 d-flex flex-column gap-3">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 border-bottom pb-3">
        <h1 class="h3 fw-bold m-0">System Logs</h1>
        <div class="btn-group shadow-sm w-md-auto">
            <button class="btn btn-sm btn-outline-dark @(IsRawView ? "active" : "")" @onclick="() => IsRawView = true">Raw View</button>
            <button class="btn btn-sm btn-outline-dark @(!IsRawView ? "active" : "")" @onclick="() => IsRawView = false">Table View</button>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-3">
        <div class="card-body p-3 p-md-4">
            <div class="row g-3 align-items-end">
                <div class="col-sm-6 col-md-3">
                    <label class="form-label small fw-bold text-muted">CATEGORY</label>
                    <select class="form-select border-2" @onchange="OnTypeChanged">
                        <option value="app-">Application</option>
                        <option value="errors-">Errors</option>
                        <option value="ef-core-">EF Core</option>
                    </select>
                </div>
                <div class="col-sm-6 col-md-4">
                    <label class="form-label small fw-bold text-muted">DATE</label>
                    <select class="form-select border-2" @bind="SelectedDateString">
                        @foreach (var date in AvailableDates)
                        {
                            <option value="@date.ToString("yyyyMMdd")">@date.ToString("dddd, MMM dd")</option>
                        }
                    </select>
                </div>
                <div class="col-sm-6 col-md-3">
                    <label class="form-label small fw-bold text-muted">Source</label>
                    <select class="form-select border-2" disabled="@(logSources.Count == 0)" @bind="SelectedSourceString">
                        @if (logSources.Count > 0)
                        {
                            <option>all</option>
                            foreach (var source in logSources)
                            {
                                if (source != "")
                                {
                                    <option>@source</option>
                                }
                            }
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-dark w-100 py-2 fw-bold" @onclick="LoadLog">Fetch</button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-grow-1 border rounded-3 bg-white d-flex flex-column overflow-hidden" style="min-height: 0;">
        <div class="flex-grow-1 overflow-auto table-responsive">
            @if (IsLoading)
            {
                <div class="h-100 d-flex align-items-center justify-content-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div> Loading...
                </div>
            }
            else if (IsRawView)
            {
                <pre class="raw-output">@RawContent</pre>
            }
            else
            {
                <table class="table table-hover mb-0" style="min-width: 850px; table-layout: fixed;">
                    <thead class="bg-light sticky-top">
                        <tr>
                            <th style="width: 15%">Time</th>
                            <th style="width: 10%">Level</th>
                            <th style="width: 20%">Source</th>
                            <th style="width: 55%">Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var entry in FilteredEntries.Count != 0 ? FilteredEntries : ParsedEntries)
                        {
                            <tr>
                                <td class="text-muted small">@entry.Timestamp.ToString("HH:mm:ss")</td>
                                <td><span class="badge rounded-pill bg-info text-dark">@entry.Level</span></td>
                                <td class="text-primary text-break" title="@entry.SourceContext">@entry.SourceContext</td>
                                <td class="text-wrap text-break fw-light small" style="line-height: 1.5;">@entry.Message</td>
                            </tr>
                        }
                        
                    </tbody>
                </table>
            }
        </div>
    </div>
</div>

<style>
    .raw-output {
        padding: 1.5rem;
        margin: 0;
        background: #1a202c;
        color: #edf2f7;
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-break: break-all;
    }

    .table th {
        border-top: none;
    }

    .overflow-auto::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .overflow-auto::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 10px;
    }

    .btn-sm {
        padding: .5rem 1rem;
    }
</style>

@code {
    private string SelectedType = "app-", SelectedDateString = "", RawContent = "";
    private List<DateTime> AvailableDates = new();
    private List<LogEntry> ParsedEntries = new(), FilteredEntries = new();
    private bool IsRawView = false, IsLoading = false;
    private List<string> logSources = new();
    private string selectedSourceString = "";

    private string SelectedSourceString
    {
        get { return selectedSourceString; }
        set
        {
            selectedSourceString = value;
            FilterLogsBySource(SelectedSourceString);
        }
    }


    protected override void OnInitialized() => RefreshDateList();

    void RefreshDateList()
    {
        AvailableDates = LogSvc.GetAvailableDates(SelectedType);
        SelectedDateString = AvailableDates.FirstOrDefault().ToString("yyyyMMdd") ?? "";
    }

    void OnTypeChanged(ChangeEventArgs e)
    {
        SelectedType = e.Value?.ToString() ?? "app-";
        RefreshDateList();
    }

    void FilterLogsBySource(string value)
    {
        if (value == "all")
        {
            FilteredEntries.Clear();
        }
        else if (!string.IsNullOrEmpty(value))
        {
            FilteredEntries = ParsedEntries.Where(entry => entry.SourceContext == value).ToList();
        }
    }

    async Task LoadLog()
    {
        if (string.IsNullOrEmpty(SelectedDateString)) return;
        SelectedSourceString = "all";
        IsLoading = true;
        RawContent = await LogSvc.ReadRawLogAsync($"{SelectedType}{SelectedDateString}.txt");
        ParsedEntries = LogSvc.ParseLogs(RawContent);
        logSources = ParsedEntries.DistinctBy(x => x.SourceContext).Select(x => x.SourceContext).ToList();
        IsLoading = false;
    }

    string ShortenContext(string c) => c.Split('.').Last();
    string GetBadgeClass(string l) => l == "ERR" ? "bg-danger" : "bg-info text-dark";
}